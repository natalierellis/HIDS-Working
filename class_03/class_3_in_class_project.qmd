---
title: "Class 3 Project"
format: 
  html:
    embed-resources: true
---

This file serves as a template for the Class 3 in-class project.

```{r}
#| warning: false
library(tidyverse)     # loads the tidyverse tools
library(RPostgres)     # loads the database driver for PostgreSQL
library(connections)   # helps RPostgres work with RStudio
library(keyring)       # access to a local encrypted keychain for passwords

con <- connection_open(RPostgres::Postgres(),
          dbname = "syntheticmguh",
          host = "34.145.215.95",
          user = "hids502_student",
          password = key_get(service = "syntheticmguh", 
                             username = "hids502_student"),
          # Tell the driver to return very large integers as floating point (vs truncating them)
          bigint = "numeric")
        
```

# Question 1

How many patients do we have in the database?

```{sql connection=con}
SELECT COUNT(*) AS patient_count FROM patients 
```

How many providers and payers are represented in the data set?

```{sql connection=con}
SELECT COUNT(*) AS providers_count FROM providers
```

```{sql connection=con}
SELECT COUNT(*) AS payers_count FROM payers
```

# Question 2

What is the mean amount spent per patient?

```{sql connection=con}
SELECT AVG(total_claim_cost) FROM encounters;
```

What does this look like broken down by year?

```{sql connection=con}
SELECT AVG(total_claim_cost),
EXTRACT(YEAR from stop) as year
FROM encounters
GROUP BY year
ORDER BY year DESC;
```

# Question 3

What is the mean amount spent for Medicare patients?

```{sql connection=con}
SELECT AVG(total_claim_cost), payers.name
FROM encounters
INNER JOIN payers
ON encounters.payer = payers.id
WHERE name = 'Medicare'
GROUP BY name;
```

What does this look like broken down by year?

```{sql connection=con}
SELECT AVG(total_claim_cost), payers.name,
EXTRACT(YEAR from stop) as year
FROM encounters
INNER JOIN payers
ON encounters.payer = payers.id
WHERE name = 'Medicare'
GROUP BY name, year;

```

# Question 4

Using a common table expression, what are the min, max, and mean number of patients per provider?

Using the raw data in R, plot this as a boxplot as well.

Here's an example of a boxplot (note the additional use of the `y` axis that you probably don't need here.)

```{sql connection=con, output.var = "patients_per_provider"}
-- first generate CTE
SELECT COUNT(DISTINCT(patient)) AS count_patients_per_provider, provider
FROM encounters
GROUP BY provider
```

```{r}
ggplot(patients_per_provider) + 
  geom_boxplot(aes(x = count_patients_per_provider, y = provider))
```

```{sql connection=con}
-- then find mean number of patients per provider
WITH patients_per_provider AS (
SELECT COUNT(DISTINCT(patient)) AS count, provider
FROM encounters
GROUP BY provider
)
SELECT AVG(count) AS avg_patients_per_provider, provider
FROM patients_per_provider
GROUP BY provider
```

```{sql connection=con, output.var="expenses_df"}
-- incorporate code into variable output 
WITH patients_per_provider AS (
SELECT COUNT(DISTINCT(patient)) AS count, provider
FROM encounters
GROUP BY provider
)
SELECT AVG(count) AS avg_patients_per_provider, provider
FROM patients_per_provider
GROUP BY provider
```

```{sql connection=con}
-- incorporate code into variable output 
WITH patients_per_provider AS (
SELECT COUNT(DISTINCT(patient)) AS count, provider
FROM encounters
GROUP BY provider
)
SELECT MAX(count) AS max_patients_per_provider, provider
FROM patients_per_provider
GROUP BY provider
```

```{sql connection=con}
-- incorporate code into variable output 
WITH patients_per_provider AS (
SELECT COUNT(DISTINCT(patient)) AS count, provider
FROM encounters
GROUP BY provider
)
SELECT MIN(count) AS min_patients_per_provider, provider
FROM patients_per_provider
GROUP BY provider
```

# Question 5

What is the min/max and mean number of encounters per patient in 2022?

Plot the distribution as a histogram â€“ this will require you to use R

Here's an example of a boxplot

```{r}
ggplot(expenses_df) + 
  geom_histogram(aes(x = healthcare_expenses))
```

# Question 6 (Optional)

What time frame does the database cover? In other words, when does the data start and when does it end?

Show the volume of visits over time (as a table or a plot)

```{sql connection=con}
-- Your code goes here
```
